#!/bin/bash -e

if [[ $# == 0 ]]; then
    id=$(xdotool getwindowfocus) &&
    prop=$(xprop -id "$id" -notype _QUBES_VMNAME) &&
    prop_regex='^_QUBES_VMNAME = "(.+)"$' &&
    [[ "$prop" =~ $prop_regex ]] &&
    set -- "${BASH_REMATCH[1]}" ||
    set -- dom0

    vm_run() { /usr/lib/qubes/qrexec-client -e -d "$1" "user:$2"; }
else
    vm_run() { qvm-run --auto -- "$1" "$2"; }  # a little slower, but has --auto
fi

for arg; do
    if [[ $arg == dom0 ]]; then
        xfce4-terminal || xterm
    else
        vm_run "$arg" 'gnome-terminal || xterm'
    fi
done
