#!/bin/bash -e

vm_terminal() {
    # fast and non-blocking
    /usr/lib/qubes/qrexec-client -e -d "$1" \
    'DEFAULT:qubes-run-terminal </dev/null >/dev/null 2>&1'
}

dom0_terminal() {
    # also non-blocking
    xfce4-terminal || { xterm & }
}

if [[ $# == 0 ]]; then
    prop_regex='^_QUBES_VMNAME = "(.+)"$'

    if id=$(xdotool getwindowfocus) &&
       prop=$(xprop -id "$id" -notype _QUBES_VMNAME) &&
       [[ "$prop" =~ $prop_regex ]]; then
        vm_terminal "${BASH_REMATCH[1]}"
    else
        dom0_terminal
    fi
else
    for vm; do
        qvm-run --quiet "$vm" :
        vm_terminal "$vm"
    done
fi
