#!/bin/bash -e

vm_terminal() {
    # fast and non-blocking
    /usr/lib/qubes/qrexec-client -e -d "$1" 'DEFAULT:gnome-terminal || xterm'
}

dom0_terminal() {
    xfce4-terminal || xterm
}

if [[ $# == 0 ]]; then
    prop_regex='^_QUBES_VMNAME = "(.+)"$'

    if id=$(xdotool getwindowfocus) &&
       prop=$(xprop -id "$id" -notype _QUBES_VMNAME) &&
       [[ "$prop" =~ $prop_regex ]]; then
        vm_terminal "${BASH_REMATCH[1]}"
    else
        dom0_terminal
    fi
else
    for arg; do
        qvm-run --quiet --no-gui --service "$arg" qubes.WaitForSession
        vm_terminal "$arg"
    done
fi
